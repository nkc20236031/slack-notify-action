name: Notify Slack - PR Review

on:
  workflow_call:
    inputs:
      pr_title:
        required: true
        type: string
      pr_url:
        required: true
        type: string
      pr_number:
        required: true
        type: number
      reviewer_github:
        required: true
        type: string
      reviewee_github:
        required: true
        type: string
      review_state:
        required: true
        type: string
      review_body:
        required: false
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        required: true
      SLACK_USER_MAP_JSON:
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Set datetime
        run: |
          export TZ=Asia/Tokyo
          echo "date_time=$(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_ENV

      - name: Convert GitHub users to Slack mentions
        run: |
          map='${{ secrets.SLACK_USER_MAP_JSON }}'

          reviewer=$(echo "$map" | jq -r --arg u "${{ inputs.reviewer_github }}" '.[$u] // empty')
          reviewee=$(echo "$map" | jq -r --arg u "${{ inputs.reviewee_github }}" '.[$u] // empty')

          if [ -n "$reviewer" ]; then
            echo "reviewer_slack=<@$reviewer>" >> $GITHUB_ENV
          else
            echo "reviewer_slack=${{ inputs.reviewer_github }}" >> $GITHUB_ENV
          fi

          if [ -n "$reviewee" ]; then
            echo "reviewee_slack=<@$reviewee>" >> $GITHUB_ENV
          else
            echo "reviewee_slack=${{ inputs.reviewee_github }}" >> $GITHUB_ENV
          fi

      - name: Build Slack payload (PR Review)
        run: |
          payload=$(jq -n \
            --arg title "${{ inputs.pr_title }}" \
            --arg pr_url "${{ inputs.pr_url }}" \
            --arg pr_number "${{ inputs.pr_number }}" \
            --arg reviewer "$reviewer_slack" \
            --arg reviewee "$reviewee_slack" \
            --arg state "${{ inputs.review_state }}" \
            --arg body "${{ inputs.review_body || '' }}" \
            --arg date_time "${{ env.date_time }}" \
          '{
            attachments: [
              {
                color: "#e82a87",
                blocks: [
                  {
                    type: "header",
                    text: {
                      type: "plain_text",
                      text: "コードレビューが行われました"
                    }
                  },
                  {
                    type: "section",
                    fields: [
                      { type: "mrkdwn", text: "*レビュワー*" },
                      { type: "mrkdwn", text: "*レビューイ*" },
                      { type: "mrkdwn", text: $reviewer },
                      { type: "mrkdwn", text: $reviewee }
                    ]
                  },
                  {
                    type: "section",
                    fields: [
                      { type: "mrkdwn", text: "*状態*" },
                      { type: "mrkdwn", text: "*PR番号*" },
                      { type: "plain_text", text: $state, emoji: true },
                      { type: "mrkdwn", text: "<\($pr_url)|#\($pr_number)>" }
                    ]
                  },
                  {
                    type: "section",
                    text: {
                      type: "mrkdwn",
                      text: $body
                    }
                  },
                  {
                    type: "context",
                    elements: [
                      {
                        type: "mrkdwn",
                        text: ("作成日：" + $date_time)
                      }
                    ]
                  }
                ]
              }
            ]
          }')

          {
            echo "payload<<EOF"
            echo "$payload"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$SLACK_WEBHOOK_URL"


