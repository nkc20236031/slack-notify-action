name: Notify Slack - PR Created

on:
  workflow_call:
    inputs:
      title:
        required: true
        type: string
      url:
        required: true
        type: string
      pr_number:
        required: true
        type: number
      author:
        required: true
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        required: true
      SLACK_USER_MAP_JSON:
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Set datetime
        run: |
          export TZ=Asia/Tokyo
          echo "date_time=$(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_ENV

      - name: Convert GitHub user to Slack mention
        id: usermap
        run: |
          slack_id=$(echo '${{ secrets.SLACK_USER_MAP_JSON }}' \
            | jq -r --arg user "${{ inputs.author }}" '.[$user] // empty')

          if [ -n "$slack_id" ]; then
            echo "author_slack=<@$slack_id>" >> $GITHUB_ENV
          else
            echo "author_slack=${{ inputs.author }}" >> $GITHUB_ENV
          fi

      - name: Build Slack payload (PR Created)
        run: |
          payload=$(jq -n \
            --arg title "${{ inputs.title }}" \
            --arg pr_url "${{ inputs.url }}" \
            --arg pr_number "${{ inputs.pr_number }}" \
            --arg author "${{ env.author_slack }}" \
            --arg date_time "${{ env.date_time }}" \
          '{
            attachments: [
              {
                color: "e82a87",
                blocks: [
                  {
                    type: "section",
                    text: {
                      type: "mrkdwn",
                      text: ($author + "\nプルリクエストを作成しました!")
                    }
                  },
                  {
                    type: "header",
                    text: {
                      type: "plain_text",
                      text: $title
                    }
                  },
                  {
                    type: "section",
                    fields: [
                      { type: "mrkdwn", text: "*作成者*" },
                      { type: "mrkdwn", text: "*PR番号*" },
                      { type: "mrkdwn", text: $author },
                      { type: "mrkdwn", text: "<\($pr_url)|#\($pr_number)>" }
                    ]
                  },
                  {
                    type: "context",
                    elements: [
                      {
                        type: "mrkdwn",
                        text: ("作成日:" + $date_time)
                      }
                    ]
                  },
                  {
                    type: "actions",
                    elements: [
                      {
                        type: "button",
                        text: {
                          type: "plain_text",
                          text: "プルリクエストを開く",
                          emoji: true
                        },
                        url: $pr_url,
                        style: "primary"
                      }
                    ]
                  }
                ]
              }
            ]
          }')

          {
            echo "payload<<EOF"
            echo "$payload"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Send to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$SLACK_WEBHOOK_URL"
